<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è‚–å››(ä¸€) iPadæœ€ç»ˆå®Œç¾é‡æ„ç‰ˆ</title>
    <!-- å¼•å…¥ Tailwind CSS å’Œ Marked.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <style>
        /* === åŸºç¡€è®¾ç½® === */
        :root {
            --sidebar-width: 320px;
            --header-height: 64px;
            --transition-speed: 0.3s;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            background-color: #f1f5f9; 
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-y;
            overflow: hidden; /* é˜²æ­¢ Body æ»šåŠ¨ */
        }

        /* === å¸ƒå±€æ ¸å¿ƒ (è§£å†³å±…ä¸­é—®é¢˜çš„å…³é”®) === */
        #app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1), 
                        margin-left var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, margin-left;
        }

        /* æ¡Œé¢/æ¨ªå±æ¨¡å¼ (lg): ä¾§è¾¹æ æŒ¤å ç©ºé—´ */
        @media (min-width: 1024px) {
            #sidebar {
                position: relative;
                margin-left: 0;
            }
            #sidebar.closed {
                margin-left: calc(var(--sidebar-width) * -1); /* è´Ÿ Margin éšè—ï¼Œä¸»å†…å®¹è‡ªåŠ¨æ‰©å¼  */
            }
            #mobile-overlay { display: none !important; } /* æ¡Œé¢ç«¯ä¸éœ€è¦é®ç½© */
        }

        /* ç§»åŠ¨/ç«–å±æ¨¡å¼ (< lg): ä¾§è¾¹æ æ‚¬æµ®è¦†ç›– (æŠ½å±‰) */
        @media (max-width: 1023px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                transform: translateX(-100%); /* é»˜è®¤éšè— */
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }

        /* ä¸»å†…å®¹åŒº */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* é˜²æ­¢ Flex å­é¡¹æº¢å‡º */
            background-color: #f1f5f9;
            position: relative;
            transition: width var(--transition-speed) ease;
        }

        /* === ç»„ä»¶æ ·å¼ === */
        
        /* é®æŒ¡æ¡ */
        .cloze {
            background-color: #cbd5e1;
            color: transparent;
            border-radius: 4px;
            padding: 2px 6px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            margin: 0 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-weight: 600;
            border-bottom: 2px solid #94a3b8;
            display: inline-block;
            vertical-align: middle;
            min-width: 2em;
        }
        .cloze.revealed {
            background-color: #fef08a;
            color: #854d0e;
            text-decoration: none;
            border-bottom: none;
            box-shadow: none;
            padding: 2px 6px;
        }
        .cloze:active { transform: scale(0.96); }

        /* Grid æŠ˜å åŠ¨ç”» (å®Œç¾è§£å†³é«˜åº¦æˆªæ–­) */
        .collapsible-grid {
            display: grid;
            grid-template-rows: 1fr;
            transition: grid-template-rows 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 1;
        }
        .collapsible-grid.collapsed {
            grid-template-rows: 0fr;
            opacity: 0;
        }
        .collapsible-inner {
            overflow: hidden;
        }

        /* æ»šåŠ¨æ¡éšè— */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* åŠ¨ç”»æ‚é¡¹ */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .group-arrow { transition: transform 0.3s; }
        .nav-group.expanded .group-arrow { transform: rotate(90deg); }
        .nav-sub-list { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .nav-group.expanded .nav-sub-list { max-height: 1000px; }

        button:active { transform: scale(0.96); opacity: 0.9; }

        /* Markdown */
        .markdown-body h1 { font-size: 1.2em; font-weight: 800; margin-top: 1em; color: #1e293b; border-left: 4px solid #8b5cf6; padding-left: 10px; }
        .markdown-body p { margin-bottom: 0.6em; line-height: 1.7; font-size: 1em; color: #334155; }
        .markdown-body strong { color: #b91c1c; background: #fee2e2; padding: 2px 5px; border-radius: 4px; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.4em; color: #475569; }
    </style>
</head>
<body>

    <div id="app-layout">
        
        <!-- ä¾§è¾¹æ  -->
        <aside id="sidebar" class=""> <!-- ç±»åç”± JS åŠ¨æ€ç®¡ç† -->
            <div class="h-16 border-b border-gray-100 flex justify-between items-center px-5 shrink-0 bg-gray-50/50 backdrop-blur-sm">
                <h3 class="font-bold text-gray-700 text-base flex items-center gap-2">
                    <span>ğŸ“–</span> é¢˜ç›®å¯¼èˆª
                </h3>
                <!-- ä»…åœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„å…³é—­æŒ‰é’® -->
                <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-gray-600 p-2 rounded-lg active:bg-gray-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-hide" id="nav-list"></div>
        </aside>

        <!-- ç§»åŠ¨ç«¯é®ç½© -->
        <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 z-40 hidden backdrop-blur-sm transition-opacity opacity-0"></div>

        <!-- ä¸»å†…å®¹åŒº -->
        <main id="main-content">
            
            <!-- é¡¶éƒ¨å¯¼èˆª (Sticky) -->
            <header class="bg-white/90 backdrop-blur-md shadow-sm z-30 px-6 h-16 border-b border-gray-200 shrink-0 flex justify-between items-center sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="text-gray-500 hover:text-blue-600 focus:outline-none p-2 rounded-xl hover:bg-gray-100 transition active:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <h1 class="text-lg font-extrabold text-gray-900 tracking-tight flex items-center gap-2">
                        ğŸš€ è‚–å››(ä¸€) <span class="hidden md:inline text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-medium">é‡æ„ç‰ˆ</span>
                    </h1>
                </div>
                
                <div class="flex items-center gap-3">
                     <div class="text-xs text-gray-400 font-mono hidden md:block bg-gray-50 px-2 py-1 rounded border border-gray-100" id="progress-text">Loading...</div>
                    <button onclick="toggleSettings()" class="text-gray-400 hover:text-blue-600 p-2 rounded-full hover:bg-gray-100 transition transform hover:rotate-90 duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
                
                <!-- è®¾ç½®é¢æ¿ -->
                <div id="settings-panel" class="hidden absolute top-16 right-4 w-80 bg-white shadow-2xl rounded-2xl border border-gray-100 p-6 z-50 animate-[fadeIn_0.2s_ease-out]">
                    <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center gap-2">ğŸ› ï¸ API é…ç½®</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">æ¥å£åœ°å€</label>
                            <input type="text" id="api-host" placeholder="https://api.chatanywhere.tech" class="w-full text-sm border border-gray-300 p-2.5 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 mb-1">API Key</label>
                            <input type="password" id="api-key" placeholder="sk-..." class="w-full text-sm border border-gray-300 p-2.5 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>
                        <button onclick="saveSettings()" class="w-full bg-blue-600 text-white text-sm font-bold py-2.5 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </header>

            <!-- å¡ç‰‡å±•ç¤ºåŒº (Flex å±…ä¸­å®¹å™¨) -->
            <!-- æ ¸å¿ƒä¿®å¤ï¼šw-full + flex justify-center items-center ç¡®ä¿ä»»ä½•æƒ…å†µéƒ½å±…ä¸­ -->
            <div class="flex-1 w-full flex justify-center items-start overflow-hidden relative">
                
                <!-- å¡ç‰‡æœ¬ä½“ -->
                <!-- æ ¸å¿ƒä¿®å¤ï¼šh-full + overflow-hidden è®©å†…éƒ¨æ»šåŠ¨ï¼Œè‡ªèº«ä¸æ»šåŠ¨ -->
                <div id="card-container" class="w-full max-w-5xl h-full bg-white md:my-6 md:rounded-3xl shadow-none md:shadow-xl border-x-0 md:border md:border-gray-100 overflow-hidden flex flex-col transition-all duration-300">
                    <!-- åŠ¨æ€å†…å®¹æ¸²æŸ“ -->
                </div>

                <!-- åº•éƒ¨æç¤º -->
                <div class="absolute bottom-4 left-0 w-full text-center text-gray-400 text-xs font-medium select-none pointer-events-none opacity-60 z-0">
                    â† å·¦å³æ»‘åŠ¨åˆ‡æ¢é¢˜ç›® â†’
                </div>
            </div>
        </main>
    </div>

    <script>
        // === 1. å…¨å±€é…ç½® ===
        let isLargeScreen = window.innerWidth >= 1024;
        let isSidebarOpen = isLargeScreen; 
        let currentIndex = 0;
        let isAnswerCollapsed = false;
        let isAiCollapsed = false;
        let isAiGenerating = false;
        
        const aiCache = {};
        const defaultConfig = { host: "https://api.chatanywhere.tech", key: "sk-P8qMcvE2FfWOmUePWPHaFyYkISs6DWAb55YMvoscHJpktbBp" };

        const cards = [
            { id: "34-1", subject: "é©¬åŸ Â· ç§‘æŠ€ä»·å€¼", q: "å¦‚ä½•ç†è§£â€œå‘å–„æƒ æ°‘ï¼Œå§‹ç»ˆæ˜¯ç§‘æŠ€åˆ›æ–°çš„ä»·å€¼å–å‘â€ï¼Ÿ", logic: "åŒåˆƒå‰‘ â†’ åˆ¶åº¦ä¿éšœ â†’ çœŸç†ä¸ä»·å€¼ç»Ÿä¸€", a: `(1) ç§‘æŠ€æ˜¯åŒåˆƒå‰‘ã€‚å…¶ä½œç”¨å—<span class="cloze">ç¤¾ä¼šåˆ¶åº¦</span>(å®¢è§‚)å’Œ<span class="cloze">è§‚å¿µè®¤è¯†</span>(ä¸»è§‚)å½±å“ã€‚æ­£ç¡®è¿ç”¨é¦–è¦æœ‰åˆç†çš„<span class="cloze">ç¤¾ä¼šåˆ¶åº¦ä¿éšœ</span>ã€‚<br><br>(2) ä»»ä½•æˆåŠŸå®è·µéƒ½æ˜¯<span class="cloze">çœŸç†å°ºåº¦</span>å’Œ<span class="cloze">ä»·å€¼å°ºåº¦</span>çš„ç»Ÿä¸€ã€‚æ¨åŠ¨ç§‘æŠ€å‘å–„æƒ æ°‘ï¼Œæ‰ç¬¦åˆä»·å€¼å°ºåº¦ï¼Œå®ç°äºŒè€…çš„ç»Ÿä¸€ã€‚` },
            { id: "34-2", subject: "é©¬åŸ Â· è®¤è¯†è®º", q: "ä¸ºä»€ä¹ˆåœ¨é¼“åŠ±åˆ›æ–°çš„åŒæ—¶ä¹Ÿè¦å®½å®¹å¤±è´¥ï¼Ÿ", logic: "è½¬åŒ–è®º(çœŸç†/è°¬è¯¯) â†’ è¿‡ç¨‹è®º(å‰è¿›/æ›²æŠ˜)", a: `(1) <span class="cloze">çœŸç†ä¸è°¬è¯¯</span>ã€æˆåŠŸä¸å¤±è´¥èƒ½ç›¸äº’è½¬åŒ–ã€‚é”™è¯¯å¾€å¾€æ˜¯æ­£ç¡®çš„å…ˆå¯¼ã€‚æ­£è§†å¹¶ä¿®æ­£é”™è¯¯ï¼Œèƒ½å®ç°è°¬è¯¯å‘çœŸç†çš„è½¬åŒ–ï¼ˆåœ¨æ‰¹åˆ¤è°¬è¯¯ä¸­å‘å±•çœŸç†ï¼‰ã€‚<br><br>(2) äº‹ç‰©å‘å±•æ˜¯<span class="cloze">å‰è¿›æ€§ä¸æ›²æŠ˜æ€§</span>çš„ç»Ÿä¸€ã€‚æ—¢è¦åšå®šä¿¡å¿ƒï¼Œåˆè¦é‡è§†æ›²æŠ˜ã€‚` },
            { id: "35-1", subject: "æ¯›ä¸­ç‰¹ Â· æ–°å‘å±•ç†å¿µ", q: "ä¸ºä½•å”¯æœ‰æ–°å‘å±•ç†å¿µè´¯ç©¿å…¨è¿‡ç¨‹ï¼Œæ‰èƒ½å®ç°æ ¼å±€ä¹‹å˜ï¼Ÿ", logic: "ç†å¿µåœ°ä½(å…ˆå¯¼) â†’ å¼•é¢†é«˜è´¨é‡å‘å±• â†’ ä¸‰å¤§å˜é©", a: `(1) ç†å¿µæ˜¯è¡ŒåŠ¨çš„<span class="cloze">å…ˆå¯¼</span>ï¼Œç®¡å…¨å±€ã€ç®¡æ ¹æœ¬ã€‚æ–°å‘å±•ç†å¿µå›ç­”äº†å‘å±•çš„ç›®çš„ã€åŠ¨åŠ›ç­‰é—®é¢˜ã€‚<br><br>(2) å®ƒå¼•é¢†æˆ‘ä»¬ä»¥<span class="cloze">é«˜è´¨é‡å‘å±•</span>ä¸ºä¸»é¢˜ï¼Œæ¨åŠ¨<span class="cloze">è´¨é‡ã€æ•ˆç‡ã€åŠ¨åŠ›</span>å˜é©ï¼Œå®ç°è´¨çš„æœ‰æ•ˆæå‡å’Œé‡çš„åˆç†å¢é•¿ã€‚` },
            { id: "35-2", subject: "æ¯›ä¸­ç‰¹ Â· é«˜è´¨é‡å‘å±•", q: "å¦‚ä½•ç†è§£ä»¥â€œé«˜è´¨é‡å‘å±•çš„ç¡®å®šæ€§â€åº”å¯¹ä¸ç¡®å®šæ€§ï¼Ÿ", logic: "é«˜è´¨é‡å®šä¹‰ â†’ äº”å¤§ç¡®å®šæ€§(æˆ˜ç•¥/æ”¿ç­–/å¸‚åœº/éŸ§æ€§/ç¯å¢ƒ)", a: `(1) é«˜è´¨é‡å‘å±•æ˜¯é¦–è¦ä»»åŠ¡ï¼Œæä¾›<span class="cloze">ç‰©è´¨åŸºç¡€</span>ï¼Œæ˜¯é•¿æ²»ä¹…å®‰çš„å¿…ç„¶è¦æ±‚ã€‚<br><br>(2) äº”ä¸ªâ€œç¡®å®šæ€§â€ï¼š<span class="cloze">å‘å±•æˆ˜ç•¥</span>(æ–¹å‘)ã€<span class="cloze">å®è§‚æ”¿ç­–</span>(å¹³ç¨³)ã€<span class="cloze">å¸‚åœºç©ºé—´</span>(æ½œåŠ›)ã€<span class="cloze">å‘å±•éŸ§æ€§</span>(æŠ—å‹)ã€<span class="cloze">æŠ•èµ„ç¯å¢ƒ</span>(æ²ƒåœŸ)ã€‚` },
            { id: "36-1", subject: "å²çº² Â· æŠ—æˆ˜æ„ä¹‰", q: "å¦‚ä½•ç†è§£æŠ—æˆ˜å…·æœ‰æ‹¯æ•‘äººç±»æ–‡æ˜ã€ä¿å«ä¸–ç•Œå’Œå¹³çš„æ„ä¹‰ï¼Ÿ", logic: "æ•Œäººæ€§è´¨ â†’ äº‹å®(æœ€æ—©/æœ€é•¿/ä»£ä»·æœ€å¤§) â†’ è´¡çŒ®", a: `(1) æ—¥æœ¬æ³•è¥¿æ–¯æ˜¯ä¸–ç•Œå…¬æ•Œã€‚æŠ—æˆ˜æ˜¯ä¸º<span class="cloze">å›½å®¶ç”Ÿå­˜ã€æ°‘æ—å¤å…´ã€äººç±»æ­£ä¹‰</span>è€Œæˆ˜ã€‚<br><br>(2) äº‹å®ï¼š<span class="cloze">ä¹ä¸€å…«</span>æ­å¹•ï¼›<span class="cloze">ä¸ƒä¸ƒäº‹å˜</span>å¼€è¾Ÿé¦–ä¸ªå¤§è§„æ¨¡æˆ˜åœºï¼›ä¸­å›½æ˜¯æ¶ˆç­æ—¥å†›çš„<span class="cloze">å†³å®šæ€§åŠ›é‡</span>ã€‚<br><br>(3) è´¡çŒ®ï¼šå‚ä¸åˆ›å»º<span class="cloze">è”åˆå›½</span>ã€‚` },
            { id: "36-2", subject: "å²çº² Â· å¼ºå†›ç›®æ ‡", q: "ä¸ºä»€ä¹ˆè¦å»ºè®¾ä¸–ç•Œä¸€æµå†›é˜Ÿï¼Ÿ", logic: "å†å²ç»éªŒ(æªæ†å­) â†’ ç°å®éœ€æ±‚(å®‰å…¨) â†’ æ­¢æˆ˜é€»è¾‘", a: `(1) å†å²ï¼šèµ°å‡ºè‹¦éš¾ä¾èµ–<span class="cloze">äººæ°‘å†›é˜Ÿ</span>ã€‚å—æ˜Œèµ·ä¹‰æ ‡å¿—ç‹¬ç«‹é¢†å¯¼æ­¦è£…çš„å¼€ç«¯ã€‚<br><br>(2) ç°å®ï¼šå¼ºå†›æ˜¯<span class="cloze">æˆ˜ç•¥æ”¯æ’‘</span>ã€‚åªæœ‰å†›äº‹å¼ºå¤§ï¼Œå›½å®¶å®‰å…¨æ‰æœ‰ä¿éšœã€‚<span class="cloze">èƒ½æˆ˜æ–¹èƒ½æ­¢æˆ˜</span>ï¼Œå¿…é¡»ä»¥æ›´å¼ºèƒ½åŠ›æå«ä¸»æƒã€‚` },
            { id: "37-1", subject: "æ€ä¿® Â· è‹±çƒˆç²¾ç¥", q: "ä¸ºä½•è‡´æ•¬è‹±çƒˆæ˜¯é’å¹´çš„â€œç²¾ç¥æ´—ç¤¼â€ï¼Ÿ", logic: "å´‡å°šè‹±é›„ â†’ ä¸‰è§‚å¡‘é€  â†’ è½¬åŒ–åŠ¨åŠ›", a: `(1) å´‡å°šè‹±é›„æ‰ä¼šäº§ç”Ÿè‹±é›„ã€‚å›½å®¶ä¸ä»…éœ€è¦ç‰©è´¨æ–‡æ˜ï¼Œæ›´éœ€è¦<span class="cloze">ç²¾ç¥æ–‡æ˜</span>ã€‚<br><br>(2) ä¼ æ‰¿ç²¾ç¥æ˜¯å¯¹<span class="cloze">ä¸‰è§‚</span>çš„æ´—ç¤¼ï¼Œèƒ½è½¬åŒ–ä¸ºçˆ±å›½æƒ…ã€å¼ºå›½å¿—ã€æŠ¥å›½è¡Œçš„<span class="cloze">å†…ç”ŸåŠ¨åŠ›</span>ã€‚` },
            { id: "37-2", subject: "æ€ä¿® Â· é’å¹´æ‹…å½“", q: "é’å¹´å¦‚ä½•å°†ä¸ªäººå¥‹æ–—ä¸å›½å®¶å‘½è¿è”ç³»ï¼Ÿ", logic: "ç†æƒ³èåˆ â†’ ä¸‰ç‚¹è¦æ±‚(å¿ƒ/å¿—/èƒ½) â†’ åˆ›æ–°", a: `(1) å®è´¨ï¼šåšæŒ<span class="cloze">ä¸ªäººç†æƒ³ä¸ç¤¾ä¼šç†æƒ³</span>çš„æœ‰æœºç»“åˆã€‚<br><br>(2) åšæ³•ï¼šâ‘ æ€€<span class="cloze">çˆ±å›½ä¹‹å¿ƒ</span>(ç«‹å¾·ä¹‹æº)ï¼›â‘¡ç«‹<span class="cloze">æŠ¥å›½ä¹‹å¿—</span>(èå…¥å¤§æˆ‘)ï¼›â‘¢å¢å¼º<span class="cloze">å›½ä¹‹èƒ½</span>(ç»ƒå°±æœ¬é¢†)ã€‚<br><br>(3) å…³é”®ï¼šå‘æŒ¥<span class="cloze">åˆ›æ–°ç²¾ç¥</span>ï¼Œæ•¢äºçªç ´ã€‚` },
            { id: "38-1", subject: "å½“ä»£ Â· å…¨çƒæ²»ç†", q: "å…¨çƒæ²»ç†å€¡è®®ä¸è”åˆå›½å®ªç« å¦‚ä½•â€œä¸€è„‰ç›¸æ‰¿â€ï¼Ÿ", logic: "è”åˆå›½åœ°ä½ â†’ å€¡è®®äº”å¤§ç†å¿µ â†’ ç›®æ ‡ä¸€è‡´", a: `(1) è”åˆå›½æ˜¯è·µè¡Œ<span class="cloze">å¤šè¾¹ä¸»ä¹‰</span>çš„æ ¸å¿ƒå¹³å°ã€‚<br><br>(2) å€¡è®®äº”å¤§ç†å¿µ(<span class="cloze">ä¸»æƒå¹³ç­‰ã€å›½é™…æ³•æ²»ã€å¤šè¾¹ä¸»ä¹‰ã€ä»¥äººä¸ºæœ¬ã€è¡ŒåŠ¨å¯¼å‘</span>)é˜æ˜äº†æ²»ç†åŸåˆ™ã€‚<br><br>(3) äºŒè€…ç²¾ç¥ä¸€è‡´ï¼Œæ—¨åœ¨æ”¯æŒè”åˆå›½å‘æŒ¥æ ¸å¿ƒä½œç”¨ï¼Œå¢å¼ºæœºåˆ¶æœ‰æ•ˆæ€§ã€‚` },
            { id: "38-2", subject: "å½“ä»£ Â· å››å¤§å€¡è®®", q: "â€œå››å¤§å…¨çƒå€¡è®®â€ä½“ç°äº†æ€æ ·çš„å¤–äº¤ç†å¿µï¼Ÿ", logic: "ç†å¿µ(å‘½è¿å…±åŒä½“) â†’ ç ´è§£èµ¤å­— â†’ å¤§å›½æ‹…å½“", a: `(1) ç†å¿µï¼šæ„å»º<span class="cloze">äººç±»å‘½è¿å…±åŒä½“</span>ï¼Œä»¥å¤©ä¸‹ä¹‹åˆ©ä¸ºåˆ©ã€‚<br><br>(2) åŠŸèƒ½ï¼šå››å¤§å€¡è®®åˆ†åˆ«ç ´è§£<span class="cloze">å’Œå¹³ã€å‘å±•ã€å®‰å…¨ã€æ²»ç†</span>å››å¤§èµ¤å­—ï¼Œæ³¨å…¥ç¨³å®šæ€§ã€‚<br><br>(3) æ„ä¹‰ï¼šå½°æ˜¾<span class="cloze">å¤§å›½æ‹…å½“</span>ï¼Œæä¾›æˆ˜ç•¥å¼•é¢†ã€‚` }
        ];

        // === 2. åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            applySidebarState();
            renderCard(currentIndex);
            renderNavList();
            setupSwipe();
            setupKeyboard();
            
            // çª—å£å˜åŒ–ç›‘å¬
            window.addEventListener('resize', () => {
                const newIsLarge = window.innerWidth >= 1024;
                if (newIsLarge !== isLargeScreen) {
                    isLargeScreen = newIsLarge;
                    // å¦‚æœåˆ‡æ¢äº†æ¨¡å¼ï¼Œé‡æ–°åº”ç”¨ä¾§è¾¹æ çŠ¶æ€
                    // ç­–ç•¥ï¼šå¤§å±ä¿æŒæ‰“å¼€ï¼Œå°å±é»˜è®¤å…³é—­
                    if (isLargeScreen) {
                        isSidebarOpen = true; 
                    } else {
                        isSidebarOpen = false;
                    }
                    applySidebarState();
                }
            });
        });

        // === 3. ä¾§è¾¹æ é€»è¾‘ (é‡æ„ç‰ˆ) ===
        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            applySidebarState();
        }

        function applySidebarState() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            // å…ˆç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»ï¼Œé˜²æ­¢å†²çª
            sidebar.classList.remove('closed', 'open');
            overlay.classList.add('hidden', 'opacity-0');

            if (isLargeScreen) {
                // æ¡Œé¢æ¨¡å¼ (>=1024px)
                // ä¾§è¾¹æ æ˜¯ relative çš„ï¼Œé€šè¿‡ margin-left æ§åˆ¶æ˜¾ç¤º/éšè—
                // æ­¤æ—¶ä¸»å†…å®¹ flex-1 ä¼šè‡ªåŠ¨å æ®å‰©ä½™ç©ºé—´ -> å®ç°å±…ä¸­
                if (!isSidebarOpen) {
                    sidebar.classList.add('closed'); // margin-left: -320px
                }
            } else {
                // ç§»åŠ¨æ¨¡å¼ (<1024px)
                // ä¾§è¾¹æ æ˜¯ fixed çš„ï¼Œè¦†ç›–åœ¨ä¸Šé¢
                if (isSidebarOpen) {
                    sidebar.classList.add('open'); // transform: translateX(0)
                    overlay.classList.remove('hidden');
                    setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                }
            }
        }

        // === 4. æ‰‹åŠ¿ä¸é”®ç›˜ ===
        function setupSwipe() {
            let touchStartX = 0;
            let touchStartY = 0;
            const container = document.getElementById('main-content'); 

            container.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', e => {
                const diffX = e.changedTouches[0].screenX - touchStartX;
                const diffY = e.changedTouches[0].screenY - touchStartY;

                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 60) {
                    if (diffX < 0) changeCard(1);
                    else changeCard(-1);
                }
            }, { passive: true });
        }

        function setupKeyboard() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') changeCard(-1);
                if (e.key === 'ArrowRight') changeCard(1);
            });
        }

        // === 5. æ¸²æŸ“é€»è¾‘ (UI ä¼˜åŒ–ç‰ˆ) ===
        function renderCard(index) {
            const card = cards[index];
            const container = document.getElementById('card-container');
            const progress = document.getElementById('progress-text');
            if(progress) progress.innerText = `Card ${index + 1} / ${cards.length}`;

            isAnswerCollapsed = false;
            isAiCollapsed = false;

            const hasCache = !!aiCache[card.id];
            const aiDisplayClass = hasCache ? "" : "hidden";

            container.innerHTML = `
                <div class="h-2 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 w-full shrink-0"></div>
                
                <!-- card-content: px-8 md:px-24 å®‰å…¨è¾¹è·ï¼Œåº•éƒ¨ 120px ç•™ç™½ç¡®ä¿ä¸æˆªæ–­ -->
                <div class="card-content p-6 px-8 md:px-24 md:py-10 flex flex-col h-full overflow-y-auto relative bg-white">
                    
                    <!-- å¤´éƒ¨ -->
                    <div class="mb-6 shrink-0 flex justify-between items-center">
                        <span class="bg-indigo-50 text-indigo-700 text-sm md:text-base font-bold px-4 py-2 rounded-xl border border-indigo-100 tracking-wide shadow-sm inline-block">
                            ${card.subject}
                        </span>
                    </div>
                    
                    <!-- é—®é¢˜ -->
                    <h2 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-8 leading-snug shrink-0 tracking-tight select-none">
                        ${card.q}
                    </h2>

                    <!-- é€»è¾‘é“¾ -->
                    <div class="bg-blue-50 border-l-8 border-blue-500 p-5 mb-0 rounded-t-xl text-base md:text-lg text-blue-900 font-mono shrink-0 shadow-sm relative group/logic">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl mt-0.5">ğŸ”—</span>
                            <div>
                                <div class="font-bold opacity-60 text-xs uppercase tracking-wider mb-1">Logic Chain</div>
                                ${card.logic}
                            </div>
                        </div>
                    </div>

                    <!-- åµŒå…¥å¼æ§åˆ¶æ  -->
                    <div class="flex flex-wrap justify-between items-center py-2 px-3 bg-gray-50 border-x border-b border-gray-100 mb-4 select-none rounded-b-xl shadow-sm">
                        <!-- å·¦ä¾§ï¼šå…¨æ˜¾/å…¨éš -->
                        <div class="flex gap-2 p-1 rounded-lg">
                            <button onclick="toggleAllCloze(true)" class="text-xs md:text-sm text-gray-600 px-3 py-1.5 rounded-md hover:bg-white hover:shadow-sm transition font-bold flex items-center gap-1 active:scale-95">ğŸ‘ï¸ å…¨æ˜¾</button>
                            <button onclick="toggleAllCloze(false)" class="text-xs md:text-sm text-gray-600 px-3 py-1.5 rounded-md hover:bg-white hover:shadow-sm transition font-bold flex items-center gap-1 active:scale-95">ğŸ™ˆ å…¨éš</button>
                        </div>

                        <!-- å³ä¾§ï¼šAI & æŠ˜å  -->
                        <div class="flex items-center gap-3">
                            <button id="btn-ai-trigger" onclick="askAI()" class="flex items-center gap-1.5 text-violet-600 hover:text-violet-700 px-3 py-1.5 rounded-lg text-xs font-bold transition hover:bg-violet-50 active:scale-95">
                                <span>âœ¨</span>
                                <span>${hasCache ? 'æŸ¥çœ‹è§£æ' : 'æ·±åº¦è§£æ'}</span>
                            </button>
                            <div class="h-4 w-px bg-gray-300"></div>
                            <button id="toggle-answer-btn" onclick="toggleAnswerVisibility()" class="text-gray-400 hover:text-blue-600 p-1.5 rounded-lg hover:bg-gray-100 transition active:scale-95 border border-transparent">
                                <svg id="toggle-icon" class="w-5 h-5 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- ç­”æ¡ˆåŒºåŸŸ (Grid å¸ƒå±€è§£å†³é«˜åº¦é—®é¢˜) -->
                    <div id="answer-wrapper" class="collapsible-grid mb-8">
                        <div class="collapsible-inner">
                            <div class="text-lg md:text-xl text-gray-800 leading-9 relative">
                                ${card.a}
                            </div>
                        </div>
                    </div>

                    <!-- AI å†…å®¹åŒºåŸŸ -->
                    <div id="ai-result-box" class="${aiDisplayClass} ai-box bg-white rounded-3xl p-6 md:p-8 border-2 border-purple-100 shrink-0 relative group shadow-[0_8px_30px_rgb(0,0,0,0.04)] transition-all mb-12">
                        <div class="flex justify-between items-center mb-4 border-b border-purple-50 pb-3">
                            <h4 class="text-transparent bg-clip-text bg-gradient-to-r from-violet-600 to-fuchsia-600 font-extrabold text-base md:text-lg flex items-center gap-2">
                                <span class="text-2xl">ğŸ¤–</span> AI æ·±åº¦åŠ©è®°è§£æ
                            </h4>
                            <div class="flex gap-2 items-center">
                                <button onclick="askAI(true)" class="text-sm text-indigo-500 hover:text-indigo-700 px-3 py-1.5 rounded-lg hover:bg-indigo-50 transition border border-indigo-100 flex items-center gap-1 font-bold" title="é‡æ–°ç”Ÿæˆ">
                                    <span>ğŸ”„</span>
                                </button>
                                <button onclick="toggleAiVisibility()" class="text-sm text-gray-400 hover:text-gray-600 px-3 py-1.5 rounded-lg hover:bg-gray-50 transition flex items-center gap-1 font-bold">
                                    <svg id="ai-toggle-icon" class="w-4 h-4 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="ai-content-wrapper" class="collapsible-grid">
                            <div class="collapsible-inner">
                                <div id="ai-content" class="text-base md:text-lg text-gray-700 leading-relaxed markdown-body"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åº•éƒ¨å ä½ï¼Œé˜²æ­¢å†…å®¹è´´åº• -->
                    <div class="h-20 shrink-0"></div>
                </div>
            `;

            document.querySelectorAll('.cloze').forEach(el => {
                el.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('revealed');
                });
            });

            if (hasCache) {
                renderMarkdownContent(aiCache[card.id], document.getElementById('ai-content'));
            }
            renderNavList();
        }

        // === 6. äº¤äº’é€»è¾‘ ===
        function toggleAnswerVisibility() { toggleCollapse('answer-wrapper', 'toggle-icon'); }
        function toggleAiVisibility() { toggleCollapse('ai-content-wrapper', 'ai-toggle-icon'); }

        function toggleCollapse(wrapperId, iconId) {
            const wrapper = document.getElementById(wrapperId);
            const icon = document.getElementById(iconId);
            const isCollapsed = wrapper.classList.contains('collapsed');

            if (isCollapsed) {
                wrapper.classList.remove('collapsed');
                icon.classList.remove('rotate-180');
            } else {
                wrapper.classList.add('collapsed');
                icon.classList.add('rotate-180');
            }
        }

        function toggleAllCloze(show) {
            document.querySelectorAll('.cloze').forEach(el => {
                if (show) el.classList.add('revealed'); else el.classList.remove('revealed');
            });
        }

        // === 7. AI è¯·æ±‚ ===
        async function askAI(forceRegenerate = false) {
            if (isAiGenerating) return;
            const card = cards[currentIndex];
            const aiBox = document.getElementById('ai-result-box');
            const aiContent = document.getElementById('ai-content');
            const btn = document.getElementById('btn-ai-trigger');
            
            // ç¡®ä¿ AI åŒºåŸŸæ˜¯å±•å¼€çš„
            const aiWrapper = document.getElementById('ai-content-wrapper');
            if(aiWrapper && aiWrapper.classList.contains('collapsed')) toggleAiVisibility();

            if (!forceRegenerate && aiCache[card.id]) {
                aiBox.classList.remove('hidden');
                setTimeout(() => { 
                    const container = document.querySelector('.card-content'); 
                    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }); 
                }, 100);
                return;
            }

            isAiGenerating = true;
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-3 w-3 text-violet-600" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> æ€è€ƒä¸­...`;
            btn.classList.add('opacity-70', 'cursor-not-allowed');

            aiBox.classList.remove('hidden');
            aiContent.innerHTML = '<div class="text-center py-10"><p class="text-gray-400 text-lg italic animate-pulse">âœ¨ AI æ­£åœ¨æå–è€ƒç‚¹...</p></div>';
            
            setTimeout(() => { const container = document.querySelector('.card-content'); container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }); }, 100);

            const prompt = `ä½ æ˜¯ä¸€åé‡‘ç‰Œæ”¿æ²»è€ƒç ”åå¸ˆã€‚è¯·é’ˆå¯¹è¿™é“é¢˜æä¾›ã€è®°å¿†é¡ºå£æºœã€‘å’Œã€æ·±åº¦è§£æã€‘ã€‚
            é¢˜ç›®ï¼š${card.q}
            é€»è¾‘ï¼š${card.logic}
            ç­”æ¡ˆè¦ç‚¹ï¼š${card.a.replace(/<[^>]+>/g, "").replace(/\[cite:.*?\]/g, "")}
            
            è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼è¾“å‡ºï¼š
            ### âš¡ è®°å¿†é¡ºå£æºœ
            > (ä¸€å¥æŠ¼éŸµã€å¥½è®°çš„é¡ºå£æºœ)
            ### ğŸ§  æ·±åº¦è§£æ
            (æ— åºåˆ—è¡¨è§£ææ ¸å¿ƒè€ƒç‚¹ï¼Œé‡ç‚¹è¯åŠ ç²—ï¼Œæ¡ç†æ¸…æ™°)
            `;

            try {
                let endpoint = localStorage.getItem('apiHost') || defaultConfig.host;
                let key = localStorage.getItem('apiKey') || defaultConfig.key;
                if (!endpoint.includes('/v1/chat/completions')) endpoint = endpoint.replace(/\/$/, '') + '/v1/chat/completions';

                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    mode: 'cors',
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.6
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const reply = data.choices[0].message.content;
                
                aiCache[card.id] = reply;
                btn.innerHTML = `<span>ğŸ“‘ æŸ¥çœ‹è§£æ</span>`;
                renderMarkdownContent(reply, aiContent);

            } catch (error) {
                aiContent.innerHTML = `<div class="text-red-500 bg-red-50 p-4 rounded-xl text-base border border-red-200">âš ï¸ è¯·æ±‚å¤±è´¥ï¼š${error.message}<br><span class="text-sm text-gray-500">è¯·æ£€æŸ¥å³ä¸Šè§’è®¾ç½®ä¸­çš„é…ç½®ã€‚</span></div>`;
                btn.innerHTML = originalBtnHtml;
            } finally {
                isAiGenerating = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        function renderNavList() {
            const list = document.getElementById('nav-list');
            const groups = {};
            cards.forEach((card, idx) => {
                const groupKey = card.id.split('-')[0];
                const subject = card.subject.split(' Â· ')[0];
                if (!groups[groupKey]) groups[groupKey] = { title: `ç¬¬${groupKey}é¢˜ ${subject}`, items: [] };
                groups[groupKey].items.push({ ...card, originalIndex: idx });
            });

            const currentCardId = cards[currentIndex].id.split('-')[0];
            list.innerHTML = Object.values(groups).map(group => {
                const isActive = group.items.some(i => i.originalIndex === currentIndex);
                const expandedClass = isActive ? 'expanded' : '';
                return `
                <div class="nav-group ${expandedClass} mb-2">
                    <div onclick="this.parentElement.classList.toggle('expanded')" class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-blue-50 rounded-xl select-none text-gray-700 transition-colors ${isActive ? 'bg-blue-50 text-blue-700' : ''}">
                        <span class="font-bold text-base">${group.title}</span>
                        <svg class="group-arrow w-4 h-4 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </div>
                    <div class="nav-sub-list space-y-1 pl-2">
                        ${group.items.map(item => `
                            <div onclick="jumpToCard(${item.originalIndex})" class="flex items-center gap-3 px-4 py-3 cursor-pointer rounded-xl transition-colors text-sm md:text-base ${item.originalIndex === currentIndex ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-100 hover:text-gray-900'}">
                                <span class="font-mono text-xs opacity-70 w-8">${item.id}</span>
                                <span class="truncate font-medium">${item.subject.split(' Â· ')[1] || item.subject}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function jumpToCard(idx) {
            currentIndex = idx;
            renderCard(currentIndex);
            // ç§»åŠ¨ç«¯ç‚¹å‡»åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
            if (window.innerWidth < 1024) { isSidebarOpen = false; applySidebarState(); }
        }

        function changeCard(dir) {
            const newIndex = currentIndex + dir;
            if (newIndex >= 0 && newIndex < cards.length) {
                currentIndex = newIndex;
                renderCard(currentIndex);
            }
        }

        function loadSettings() {
            document.getElementById('api-host').value = localStorage.getItem('apiHost') || defaultConfig.host;
            document.getElementById('api-key').value = localStorage.getItem('apiKey') || defaultConfig.key;
        }
        function saveSettings() {
            localStorage.setItem('apiHost', document.getElementById('api-host').value.trim() || defaultConfig.host);
            localStorage.setItem('apiKey', document.getElementById('api-key').value.trim() || defaultConfig.key);
            toggleSettings();
            alert('âœ… è®¾ç½®å·²ä¿å­˜');
        }
        function toggleSettings() { document.getElementById('settings-panel').classList.toggle('hidden'); }
        function renderMarkdownContent(text, el) {
            el.classList.add('fade-in');
            el.innerHTML = typeof marked !== 'undefined' ? marked.parse(text) : text.replace(/\n/g, '<br>');
            setTimeout(() => { const container = document.querySelector('.card-content'); container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }); }, 100);
        }
    </script>
</body>
</html>